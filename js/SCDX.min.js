// SCDX (c) 2013, Brian Milton
(function(k,e){var w={},j=[{n:"Jan",d:31},{n:"Feb",d:28},{n:"Mar",d:31},{n:"Apr",d:30},{n:"May",d:31},{n:"Jun",d:30},{n:"Jul",d:31},{n:"Aug",d:31},{n:"Sep",d:30},{n:"Oct",d:31},{n:"Nov",d:30},{n:"Dec",d:31}],s=100,n=daysThisYear=0,t=[],C=new Date(),h,r,v,b,o,m,A,E,i,q,d,c,g,f,l={isHovering:false,project:{}},a=document.createElement("canvas"),u=document.createElement("canvas"),p=document.createElement("span");a.id="SCDX-viewLayer";u.id="SCDX-errorMessage";p.id="SCDX-toolTip";w.highPrioColor="#F66";w.lowPrioColor="#6F6";w.defaultPrioColor="#66F";w.roundedCorners=true;w.timeToFade=1000;w.fontFace="bold 16px Arial";w.createSchedule=function(G,K,J,F,H){o=document.getElementById(G);m=G;E=A=Number(K)||C.getFullYear();b=Number(J)||o.getAttribute("width");i=Number(F)||12;q=Number(H)||C.getMonth()+1;if(Number(A)%4!=0){j[1].d=28}else{j[1].d=29}o.innerHTML="";o.style.position="relative";v=a.getContext("2d");o.appendChild(a);o.appendChild(p);o.appendChild(u);d=Number(Date.parse("01 "+j[q-1].n+" "+A+" 00:00:00 GMT"));c=q+i;var L=q-1;daysThisYear=0;for(var I=0;I<i;I++){if(L==12){L=0;E++;if(E%4==0){j[1].d=29}else{j[1].d=28}}daysThisYear+=j[L].d;L++}c=(d+((daysThisYear)*86400000))-1;a.width=b;h=b*0.15625;r=(b-h)/daysThisYear;B()};w.changeView=function(H,G,F){w.createSchedule(m,H,b,F,G);B()};w.setSchedule=function(H){if(typeof H!="object"){w.displayErrorMessage("Invalid schedule object.");return}for(var G=0,F=H.length;G<F;G++){t.push(H[G])}s=a.height=(Math.max.apply(Math,t.map(function(I){return I.groupId}))+1)*49;B()};w.displayErrorMessage=function(G,F){u.style.opacity=1;u.style.visibility="visible";obj=a;g=obj.offsetLeft;f=obj.offsetTop;while(obj.offsetParent){g+=obj.offsetLeft;f+=obj.offsetTop;if(obj==document.getElementsByTagName("body")[0]){break}else{obj=obj.offsetParent}}u.style.left=g;u.style.top=f;u.width=a.width;u.height=a.height;overlayctx=u.getContext("2d");overlayctx.fillStyle="rgba(255,255,255,0.5)";overlayctx.fillRect(0,0,b,s);overlayctx.fillStyle="#FFFFE0";overlayctx.strokeStyle="#333";overlayctx.font=w.fontFace;if(w.roundedCorners){y(overlayctx,(b/4),(s/4),(b/2),(s/2),5,true,true)}else{overlayctx.fillRect((b/4),(s/4),(b/2),(s/2));overlayctx.strokeRect((b/4),(s/4),(b/2),(s/2))}overlayctx.fillStyle="#F00";overlayctx.textAlign="center";overlayctx.fillText(G,b/2,(s/2)+5);setTimeout(function(){x(u,F)},2500)};function y(I,H,M,J,G,F,L,K){if(typeof K=="undefined"){K=false}if(typeof F==="undefined"){F=5}I.beginPath();I.moveTo(H+F,M);I.lineTo(H+J-F,M);I.quadraticCurveTo(H+J,M,H+J,M+F);I.lineTo(H+J,M+G-F);I.quadraticCurveTo(H+J,M+G,H+J-F,M+G);I.lineTo(H+F,M+G);I.quadraticCurveTo(H,M+G,H,M+G-F);I.lineTo(H,M+F);I.quadraticCurveTo(H,M,H+F,M);I.closePath();if(K){I.stroke()}if(L){I.fill()}}function B(){E=A;a.width=u.width=b;a.height=u.height=s;var M=h;v.moveTo(0,26.5);v.lineTo(b,26.5);v.moveTo(M,0);v.lineTo(M,s);v.fillStyle="#333333";v.font=w.fontFace;v.fillText(E,M+5,21);var H=q-1;v.strokeStyle="#CCC";for(var K=0;K<i;K++){if(H==12){E++;if((E+1)%4==0){j[1].d=29}else{j[1].d=28}v.fillText(E,M+5,21);H=0;v.moveTo(M,0);v.lineTo(M,s)}v.fillText(j[H].n,M+5,42);M+=j[H].d*r;v.moveTo(M,47.5);v.lineTo(M,s);H++}v.moveTo(0,47.5);v.lineTo(b,47.5);v.stroke();if(t.length>0){var Q=Math.max.apply(Math,t.map(function(U){return U.groupId})),T=Math.round((s-47.5)/Q)-1;v.strokeStyle="#CCC";for(var K=0,O=Q;K<O;K++){v.moveTo(0,Math.round((T*(K+1))+49)-0.5);v.lineTo(b,Math.round((T*(K+1))+49)-0.5);v.stroke()}for(var K=0,O=t.length;K<O;K++){var I=t[K].startDate,N=t[K].endDate,P=h,L=endDay=z=0,H=q,S=t[K];E=A;if(t[K].groupId!=n){n=t[K].groupId;v.fillStyle="#333";v.fillText(t[K].rowLabel,5,((t[K].groupId+0.6)*49))}switch(S.prio){case"high":v.fillStyle=v.strokeStyle=w.highPrioColor;break;case"low":v.fillStyle=v.strokeStyle=w.lowPrioColor;break;default:v.fillStyle=v.strokeStyle=w.defaultPrioColor;break}var J=false,R=S.groupId*49,G,F;if(S.startDate>=d&&S.endDate<=c){G=(((S.endDate-S.startDate)/86400000)+1)*r;F=h+(((S.startDate-d)/86400000)*r);J=true}else{if(S.endDate>d&&S.endDate<c){G=(((S.endDate-d)/86400000)+1)*r;F=h;J=true}else{if(S.startDate>d&&S.startDate<c&&S.endDate>c){G=(((c-S.startDate)/86400000)+1)*r;F=h+(((S.startDate-d)/86400000)*r);J=true}else{if(S.startDate<=d&&S.endDate>=c){G=(((c-d)/86400000)+1)*r;F=h;J=true}}}}if(J){t[K].xPos=F;t[K].yPos=R;t[K].width=G;t[K].height=47.5;if(w.roundedCorners){y(v,F,R,G,47.5,5,true,true)}else{v.clearRect(F,R,G,47.5);v.fillRect(F,R,G,47.5);v.strokeRect(F,R,G,47.5)}}}}else{w.displayErrorMessage("No projects to display.")}}function x(G,F){w.timeToFade=F?F:w.timeToFade;if(G==null){return}if(G.FadeState==null){if(G.style.opacity==null||G.style.opacity==""||G.style.opacity=="1"){G.FadeState=2}else{G.FadeState=-2}}if(G.FadeState==1||G.FadeState==-1){G.FadeState=G.FadeState==1?-1:1;G.FadeTimeLeft=w.timeToFade-G.FadeTimeLeft}else{G.FadeState=G.FadeState==2?-1:1;G.FadeTimeLeft=w.timeToFade;setTimeout(D(new Date().getTime(),G),33)}}function D(H,G){var F=new Date().getTime();var J=F-H;if(G.FadeTimeLeft<=J){G.style.opacity=G.FadeState==1?1:0;G.FadeState=G.FadeState==1?2:-2;if(G.FadeState==-2){G.style.visibility="hidden"}return}G.FadeTimeLeft-=J;var I=G.FadeTimeLeft/w.timeToFade;if(G.FadeState==1){I=1-I}G.style.opacity=I;setTimeout(function(){D(F,G)},33)}a.onmousemove=a.onmouseover=function(J){J=J||k.event;if(l.isHovering){G=l.project;if((J.layerX>G.xPos)&&(J.layerX<(G.xPos+G.width))&&((J.layerY>G.yPos)&&(J.layerY<(G.yPos+G.height)))){p.style.left=(J.clientX+15)+"px";p.style.top=J.clientY+"px"}else{l.isHovering=false;p.style.visibility="hidden"}}else{if(t.length!=0){for(var H=0,F=t.length;H<F;H++){var G=t[H];if((J.layerX>G.xPos)&&(J.layerX<(G.xPos+G.width))&&((J.layerY>G.yPos)&&(J.layerY<(G.yPos+G.height)))){var K=new Date(G.startDate),I=new Date(G.endDate);if(typeof G.description!="undefined"){p.style.left=(J.clientX+15)+"px";p.style.top=J.clientY+"px";p.style.visibility="visible";p.innerHTML=G.description+"<br>"+K.getUTCDate()+"-"+j[K.getUTCMonth()].n+"-"+K.getUTCFullYear()+" <b>&#8594;</b> "+I.getUTCDate()+"-"+j[I.getUTCMonth()].n+"-"+I.getUTCFullYear();l.isHovering=true;l.project=G}else{p.style.left=(J.clientX+15)+"px";p.style.top=J.clientY+"px";p.style.visibility="visible";p.innerHTML="Start:"+K.getUTCDate()+"-"+j[K.getUTCMonth()].n+"-"+K.getUTCFullYear()+"<br>End:"+I.getUTCDate()+"-"+j[I.getUTCMonth()].n+"-"+I.getUTCFullYear();l.isHovering=true;l.project=G}}}}}};a.onmouseout=function(){p.style.visibility="hidden"};k.SCDX=w})(window);