// SCDX (c) 2013, Brian Milton
(function(l,f){var y={},k=[{n:"Jan",d:31},{n:"Feb",d:28},{n:"Mar",d:31},{n:"Apr",d:30},{n:"May",d:31},{n:"Jun",d:30},{n:"Jul",d:31},{n:"Aug",d:31},{n:"Sep",d:30},{n:"Oct",d:31},{n:"Nov",d:30},{n:"Dec",d:31}],u=100,v=[],E=new Date(),n={isHovering:false,project:{}},b=document.createElement("canvas"),x=document.createElement("canvas"),s=document.createElement("span"),o=true,q,a,i,t,w,c,p,m,C,G,j,r,e,d,h,g;b.id="SCDX-viewLayer";x.id="SCDX-errorMessage";s.id="SCDX-toolTip";y.highPrioColor="#F66";y.lowPrioColor="#6F6";y.defaultPrioColor="#66F";y.roundedCorners=true;y.timeToFade=1000;y.fontFace="bold 16px Arial";y.floatTip=true;y.createSchedule=function(I,M,L,H,J){p=document.getElementById(I);m=I;G=C=Number(M)||E.getFullYear();c=Number(L)||p.getAttribute("width");j=Number(H)||12;r=Number(J)||E.getMonth()+1;if(Number(C)%4!=0){k[1].d=28}else{k[1].d=29}p.innerHTML="";p.style.position="relative";w=b.getContext("2d");p.appendChild(b);p.appendChild(s);p.appendChild(x);e=Number(Date.parse("01 "+k[r-1].n+" "+C+" 00:00:00 GMT"));d=r+j;var N=r-1;a=0;for(var K=0;K<j;K++){if(N==12){N=0;G++;if(G%4==0){k[1].d=29}else{k[1].d=28}}a+=k[N].d;N++}d=(e+((a)*86400000))-1;b.width=c;i=c*0.15625;t=(c-i)/a;D()};y.changeView=function(J,I,H){y.createSchedule(m,J,c,H,I);D()};y.setSchedule=function(J){if(typeof J!="object"){y.displayErrorMessage("Invalid schedule object.");return}o=false;for(var I=0,H=J.length;I<H;I++){v.push(J[I])}u=b.height=(Math.max.apply(Math,v.map(function(K){return K.groupId}))+1)*49;D()};y.displayErrorMessage=function(I,H){x.FadeState=2;x.style.opacity=1;x.style.visibility="visible";obj=b;h=obj.offsetLeft;g=obj.offsetTop;while(obj.offsetParent){h+=obj.offsetLeft;g+=obj.offsetTop;if(obj==document.getElementsByTagName("body")[0]){break}else{obj=obj.offsetParent}}x.style.left=h;x.style.top=g;x.width=b.width;x.height=b.height;overlayctx=x.getContext("2d");overlayctx.fillStyle="rgba(255,255,255,0.5)";overlayctx.fillRect(0,0,c,u);overlayctx.fillStyle="#FFFFE0";overlayctx.strokeStyle="#333";overlayctx.font=y.fontFace;if(y.roundedCorners){B(overlayctx,(c/4),(u/4),(c/2),(u/2),5,true,true)}else{overlayctx.fillRect((c/4),(u/4),(c/2),(u/2));overlayctx.strokeRect((c/4),(u/4),(c/2),(u/2))}overlayctx.fillStyle="#F00";overlayctx.textAlign="center";overlayctx.fillText(I,c/2,(u/2)+5);setTimeout(function(){A(x,H)},2500)};function B(K,J,O,L,I,H,N,M){if(typeof M=="undefined"){M=false}if(typeof H==="undefined"){H=5}K.beginPath();K.moveTo(J+H,O);K.lineTo(J+L-H,O);K.quadraticCurveTo(J+L,O,J+L,O+H);K.lineTo(J+L,O+I-H);K.quadraticCurveTo(J+L,O+I,J+L-H,O+I);K.lineTo(J+H,O+I);K.quadraticCurveTo(J,O+I,J,O+I-H);K.lineTo(J,O+H);K.quadraticCurveTo(J,O,J+H,O);K.closePath();if(M){K.stroke()}if(N){K.fill()}}function D(){G=C;b.width=x.width=c;b.height=x.height=u;var O=i;w.moveTo(0,26.5);w.lineTo(c,26.5);w.moveTo(O,0);w.lineTo(O,u);w.fillStyle="#333333";w.font=y.fontFace;w.fillText(G,O+5,21);var J=r-1;w.strokeStyle="#CCC";for(var M=0;M<j;M++){if(J==12){G++;if((G+1)%4==0){k[1].d=29}else{k[1].d=28}w.fillText(G,O+5,21);J=0;w.moveTo(O,0);w.lineTo(O,u)}w.fillText(k[J].n,O+5,42);O+=k[J].d*t;w.moveTo(O,47.5);w.lineTo(O,u);J++}w.moveTo(0,47.5);w.lineTo(c,47.5);w.stroke();if(v.length>0){var S=Math.max.apply(Math,v.map(function(W){return W.groupId})),V=Math.round((u-47.5)/S)-1;w.strokeStyle="#CCC";for(var M=0,Q=S;M<Q;M++){w.moveTo(0,Math.round((V*(M+1))+49)-0.5);w.lineTo(c,Math.round((V*(M+1))+49)-0.5);w.stroke()}for(var M=0,Q=v.length;M<Q;M++){var K=v[M].startDate,P=v[M].endDate,R=i,N=endDay=z=0,J=r,U=v[M];G=C;if(v[M].groupId!=q){q=v[M].groupId;w.fillStyle="#333";w.fillText(v[M].rowLabel,5,((v[M].groupId+0.6)*49))}switch(U.prio){case"high":w.fillStyle=w.strokeStyle=y.highPrioColor;break;case"low":w.fillStyle=w.strokeStyle=y.lowPrioColor;break;default:w.fillStyle=w.strokeStyle=y.defaultPrioColor;break}var L=false,T=U.groupId*49,I,H;if(U.startDate>=e&&U.endDate<=d){I=(((U.endDate-U.startDate)/86400000)+1)*t;H=i+(((U.startDate-e)/86400000)*t);L=true}else{if(U.endDate>e&&U.endDate<d){I=(((U.endDate-e)/86400000)+1)*t;H=i;L=true}else{if(U.startDate>e&&U.startDate<d&&U.endDate>d){I=(((d-U.startDate)/86400000)+1)*t;H=i+(((U.startDate-e)/86400000)*t);L=true}else{if(U.startDate<=e&&U.endDate>=d){I=(((d-e)/86400000)+1)*t;H=i;L=true}}}}if(L){v[M].xPos=H;v[M].yPos=T;v[M].width=I;v[M].height=47.5;if(y.roundedCorners){B(w,H,T,I,47.5,5,true,true)}else{w.clearRect(H,T,I,47.5);w.fillRect(H,T,I,47.5);w.strokeRect(H,T,I,47.5)}}}}else{if(!o){y.displayErrorMessage("No projects to display.")}}}function A(I,H){y.timeToFade=H?H:y.timeToFade;if(I==null){return}if(I.FadeState==null){if(I.style.opacity==null||I.style.opacity==""||I.style.opacity=="1"){I.FadeState=2}else{I.FadeState=-2}}if(I.FadeState==1||I.FadeState==-1){I.FadeState=I.FadeState==1?-1:1;I.FadeTimeLeft=y.timeToFade-I.FadeTimeLeft}else{I.FadeState=I.FadeState==2?-1:1;I.FadeTimeLeft=y.timeToFade;setTimeout(F(new Date().getTime(),I),33)}}function F(J,I){var H=new Date().getTime();var L=H-J;if(I.FadeTimeLeft<=L){I.style.opacity=I.FadeState==1?1:0;I.FadeState=I.FadeState==1?2:-2;if(I.FadeState==-2){I.style.visibility="hidden"}return}I.FadeTimeLeft-=L;var K=I.FadeTimeLeft/y.timeToFade;if(I.FadeState==1){K=1-K}I.style.opacity=K;setTimeout(function(){F(H,I)},33)}b.onmousemove=b.onmouseover=function(L){L=L||l.event;if(n.isHovering){I=n.project;if((L.layerX>I.xPos)&&(L.layerX<(I.xPos+I.width))&&((L.layerY>I.yPos)&&(L.layerY<(I.yPos+I.height)))){if(y.floatTip){s.style.left=(L.clientX+15)+"px";s.style.top=(L.clientY-30)+"px"}else{s.style.left=(I.xPos+I.width)+"px";s.style.top=I.yPos+"px"}}else{n.isHovering=false;s.style.visibility="hidden"}}else{if(v.length!=0){for(var J=0,H=v.length;J<H;J++){var I=v[J];if((L.layerX>I.xPos)&&(L.layerX<(I.xPos+I.width))&&((L.layerY>I.yPos)&&(L.layerY<(I.yPos+I.height)))){var M=new Date(I.startDate),K=new Date(I.endDate);if(typeof I.description!="undefined"){if(y.floatTip){s.style.left=(L.clientX+15)+"px";s.style.top=(L.clientY-30)+"px"}else{s.style.left=(I.xPos+I.width)+"px";s.style.top=I.yPos+"px"}s.style.visibility="visible";s.innerHTML=I.description+"<br>"+M.getUTCDate()+"-"+k[M.getUTCMonth()].n+"-"+M.getUTCFullYear()+" <b>&#8594;</b> "+K.getUTCDate()+"-"+k[K.getUTCMonth()].n+"-"+K.getUTCFullYear();n.isHovering=true;n.project=I}else{if(y.floatTip){s.style.left=(L.clientX+15)+"px";s.style.top=(L.clientY-30)+"px"}else{s.style.left=(I.xPos+I.width)+"px";s.style.top=I.yPos+"px"}s.style.visibility="visible";s.innerHTML="Start:"+M.getUTCDate()+"-"+k[M.getUTCMonth()].n+"-"+M.getUTCFullYear()+"<br>End:"+K.getUTCDate()+"-"+k[K.getUTCMonth()].n+"-"+K.getUTCFullYear();n.isHovering=true;n.project=I}}}}}};b.onmouseout=function(){s.style.visibility="hidden"};l.SCDX=y})(window);